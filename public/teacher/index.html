<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Teacher Dashboard</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg-color: #f5f7fa;
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --text-color: #2c3e50;
      --button-text: #ffffff;
    }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    #qr-section, #students-section, #activities-section {
      margin-bottom: 20px;
    }
    img {
      max-width: 200px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin: 4px 0;
    }
    button {
      background-color: var(--secondary-color);
      color: var(--button-text);
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      margin-top: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Teacher Dashboard</h1>
  <div id="qr-section">
    <h2>Student Login QR Code</h2>
    <img id="qr-code" alt="QR Code" />
  </div>
  <div id="students-section">
    <h2>Logged In Students</h2>
    <ul id="student-list"></ul>
  </div>
  <div id="activities-section">
    <h2>Activities</h2>
    <ul id="activities-list"></ul>
  </div>
  <script>
    (function(){
      const socket = io({ query: { role: 'teacher' } });
      const studentList = document.getElementById('student-list');
      socket.on('updateStudentList', students => {
        studentList.innerHTML = '';
        students.forEach(s => {
          const li = document.createElement('li');
          li.textContent = s.name + ' (' + s.studentId + ')';
          studentList.appendChild(li);
        });
      });
      // Generate QR code for student login
      const qrImg = document.getElementById('qr-code');
      const loginURL = window.location.origin + '/student';
      fetch('/api/qrcode?text=' + encodeURIComponent(loginURL))
        .then(res => res.json())
        .then(data => {
          qrImg.src = data.dataUrl;
        });
      // 動態載入活動列表與細分測驗集 (sets)
      fetch('/api/activities')
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById('activities-list');
          data.activities.forEach(activity => {
            // 先嘗試抓取此活動的測驗集
            fetch(`/api/activities/${activity}/sets`)
              .then(res2 => res2.json())
              .then(obj => {
                if (obj.sets && obj.sets.length > 0) {
                  // 針對每個測驗集建立按鈕
                  obj.sets.forEach(setName => {
                    const li = document.createElement('li');
                    const btn = document.createElement('button');
                    btn.textContent = setName;
                    btn.addEventListener('click', () => {
                      socket.emit('launchActivity', activity);
                      // 傳遞測驗集參數到教師頁面
                      window.location.href = `/activities/${activity}/teacher.html?set=${encodeURIComponent(setName)}`;
                    });
                    li.appendChild(btn);
                    list.appendChild(li);
                  });
                } else {
                  // 無測驗集，直接啟動活動
                  const li = document.createElement('li');
                  const btn = document.createElement('button');
                  btn.textContent = activity;
                  btn.addEventListener('click', () => {
                    socket.emit('launchActivity', activity);
                    window.location.href = `/activities/${activity}/teacher.html`;
                  });
                  li.appendChild(btn);
                  list.appendChild(li);
                }
              });
          });
        });
    })();
  </script>
</body>
</html>